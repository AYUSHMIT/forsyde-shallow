<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>5. FSVec issues</title><link rel="stylesheet" href="fptools.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.73.2"><link rel="start" href="index.html" title="ForSyDe tutorial"><link rel="up" href="apa.html" title="A. FSVecs: Vectors parameterized in size"><link rel="prev" href="apas04.html" title="4. Fixed Sized Vectors themselves"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5. <code class="code">FSVec</code> issues</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="apas04.html">Prev</a> </td><th width="60%" align="center">A. <code class="literal">FSVec</code>s: Vectors parameterized in size</th><td width="20%" align="right"> </td></tr></table><hr></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id1268883"></a>5. <code class="code">FSVec</code> issues</h3></div></div></div>
	

	<div class="orderedlist"><ol type="1"><li>
	    <p>
	      Some functions such as <code class="code">filter</code> cannot be
	      implemented. One can think about something along the
	      lines of:
	    </p> 
	    <pre class="programlisting">
filter :: (a -&gt; Bool) -&gt; FSVec s a -&gt; FSVec s2 a
	    </pre>
	      
	    <p>
	      However, the size of the output vector (<code class="code">s2</code>) cannot be precalculated
	      statically.
	    </p>
	  
	  </li><li>
	    <p>
	      Since <code class="code">FSVec</code> is an abstract data type,
	      pattern matching is lost, but that is the general case
	      in vector implementations
	      <sup>[<a name="id1269060" href="#ftn.id1269060" class="footnote">9</a>]</sup>.
	    </p>
	  </li><li>
	    <p>
	      It is difficult to build a vector from a list. Again, the first thing one would
	      think of would be
	    </p>
	    <pre class="programlisting">  
vector :: Nat s =&gt; [a] -&gt; FSVec s a
	    </pre>
	    
	    <p>
	      However, since <code class="code">s</code> would be a different type
	      depending on the length of <code class="code">[a]</code>, this is not
	      a valid Haskell function.  <code class="code">s</code> is
	      existentially quantified, a feature not supported
	      directly by Haskell98.
	    </p>

	    <p>
	      In addition, since the list-length is a run-time
	      condition, it is impossible to guess at compile
	      time.
	    </p>
	    
	    <p>
	      However, there are a few workarounds which are already
	      included in the library:
	    </p>
	    
	    <div class="orderedlist"><ol type="a"><li>
		<p>
		  As suggested in Eaton's <a class="ulink" href="http://ofb.net/~frederik/vectro/draft-r2.pdf" target="_top">Statically
		  Typed Linear Algebra in Haskell</a>, emulate an
		  existential through <a class="ulink" href="http://en.wikibooks.org/wiki/Haskell/Continuation_passing_style" target="_top">CPS</a>
		  (Continuation passing style). CPS is a style of
		  programming where functions never return values, but
		  instead take an extra parameter which they give
		  their result to.
		</p>

		<pre class="programlisting">		
vectorCPS :: Nat s =&gt; vectorCPS :: [a] -&gt; (forall s. Nat s =&gt; FSVec s a -&gt; w) -&gt; w
		</pre>

		<p>
		  Note that the <code class="code">forall</code> keyword is due to  using Rank2 types 
		  to emulate the existential. You don't
		  really need to understand how they work but just know to use
		  vectorCPS. Here is an example:
		</p>
		
		<pre class="screen">
$ ghci
Prelude&gt; :m +Data.Param
Prelude Data.Param&gt; (vectorCPS [1,2,3,4]) Data.Param.length
4
		</pre>
		
		<p>
		  Note that length is passed to the result of <code class="code">vectorCPS</code> and not the
		  other way around.
		</p>
		
	      </li><li>
		<p>
		  Unsafely provide the length of the resulting vector:
		</p>
		
		<pre class="programlisting">
unsafeVector :: Nat s =&gt; s -&gt; [a] -&gt; FSVec s a
		</pre>
	    
		<p>
		  <code class="code">unsafeVector</code> doesn't suffer the
		  "existential type" problem of <code class="code">vectorCPS</code>,
		  however it can happen that the dynamic length of the
		  list doesn't match the provided length (that is why the
		  function name has an "unsafe" prefix). Furthermore if
		  that is the case, we will only be able to know at
		  runtime.
		</p>
		
		<pre class="programlisting">
Prelude Data.Param&gt; :m +Data.TypeLevel
Prelude Data.Param Data.TypeLevel&gt; unsafeVector d8 [1,2]
*** Exception: unsafeVector: dynamic/static length mismatch
Prelude Data.Param Data.TypeLevel&gt; unsafeVector d2 [1,2]
&lt;1,2&gt;
		</pre>	    
	      </li><li>
		<p>
		  Template Haskell.
		</p>
		
		<p>
		  This is the preferred solution. The only problem is that, of course,
		  the TH extension is required (but we already had that dependency in ForSyDe) and you
		  can only use it with lists which are available at compile time (which,
		  for the general case of ForSyDe designs should not be a problem).
		</p>
		
		<pre class="screen">
$ ghci -XTemplateHaskell
Prelude&gt; :m +Data.Param
Prelude Data.Param&gt; $(vectorTH [1 :: Int,2,3,4])
Prelude Data.Param&gt; :t $(vectorTH [1 :: Int,2,3,4])
$(vectorTH [1 :: Int,2,3,4]) :: (Num t) =&gt; FSVec Data.TypeLevel.Num.Reps.D4 t
		</pre>
		
	      </li></ol></div>
	  </li></ol></div>
	 	
	
	
      <div class="footnotes"><br><hr width="100" align="left"><div class="footnote">
		<p><sup>[<a name="ftn.id1269060" href="#id1269060" class="para">9</a>] </sup>
		  We tried to implement pattern matching using the
		  <a class="ulink" href="http://www.haskell.org/ghc/dist/current/docs/users_guide/template-haskell.html#th-quasiquotation" target="_top">new
		  Quasiquoting mechanism in GHC</a> <a class="ulink" href="http://www.haskell.org/pipermail/template-haskell/2008-February/000655.html" target="_top">
		  without success</a>.
		</p>
	      </div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="apas04.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="apa.html">Up</a></td><td width="40%" align="right"> </td></tr><tr><td width="40%" align="left" valign="top">4. Fixed Sized Vectors themselves </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div></body></html>
